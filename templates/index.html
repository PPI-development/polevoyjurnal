<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –æ—Ç—á–µ—Ç–æ–≤</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.71/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.71/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>


    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #header {
            width: 100%;
            height: 80px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
        }

        #header .left {
            display: flex;
            align-items: center;
        }

        #header .logo {
            width: 60px;
            height: 60px;
            background: url('/static/logo.png') no-repeat center center;
            background-size: contain;
            margin-right: 10px;
        }

        #header .title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        #header .stats-button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            margin-right: 30px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è */
        }

        #header .stats-button:hover {
            background-color: #0056b3;
        }

        #content {
            display: flex;
            width: 100%;
            height: calc(100vh - 80px);
        }

        #report-list {
            width: 30%;
            height: 100%;
            overflow-y: auto;
            background-color: #f8f8f8;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .report-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background-color: #28a745;
            color: white;
            text-align: left;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .report-button:hover {
            background-color: #218838;
        }

        #map {
            width: 70%;
            height: 100%;
            position: relative;
        }

        .popup {
            min-width: 600px;
            min-height: 600px;
            max-width: 900px;
            background: white;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.3);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫—Ä–µ—Å—Ç–∏–∫–æ–º */
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            cursor: grab;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ */
        .popup-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* –õ–µ–≤—ã–π –±–ª–æ–∫ (–¢–ï–ö–°–¢) */
        .popup-left {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 500px;
            white-space: nowrap;
        }

        /* –ü—Ä–∞–≤—ã–π –±–ª–æ–∫ (–§–û–¢–û) */
        .popup-right {
            width: 45%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px;
            overflow-y: auto;
            max-height: 500px;
        }

        /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–æ—Ç–æ */
        .popup-right img {
            max-width: 100%;
            max-height: 450px;
            height: auto;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        /* –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ */
        .no-photo {
            font-size: 18px;
            font-weight: bold;
            color: #999;
            text-align: center;
        }

        #filters {
            margin-bottom: 5px;
        }

        #filters label {
            display: block;
            margin: 10px 0 5px;
        }

        #filters select, #filters button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        #filters button {
            background-color: #007BFF;
            color: white;
            cursor: pointer;
        }

        #filters button:hover {
            background-color: #0056b3;
        }

        /* –°—Ç–∏–ª—å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        #stats-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            min-height: 400px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            overflow: hidden;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        #stats-modal h3 {
            margin-top: 0;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–ª—è –¥–∞—Ç—ã */
        .date-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
            cursor: pointer; /* –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å */
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–∞—Ç—ã */
        .date-container input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            background: white;
            appearance: none; /* –û—Ç–∫–ª—é—á–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω—É—é —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—é */
            cursor: pointer;
        }

        /* –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∏–∫–æ–Ω–∫—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
        .date-container input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
        }

        /* –î–µ–ª–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∏–∫–æ–Ω–∫—É */
        .date-container::after {
            content: 'üìÖ'; /* –ò–∫–æ–Ω–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            cursor: pointer;
            pointer-events: none;
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É" */
        #stats-modal button {
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }

        #stats-modal button:hover {
            background-color: #0056b3;
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å" */
        #close-modal {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            display: block;
            width: 100px;
            margin: 20px auto 0;
            text-align: center;
        }

        #close-modal:hover {
            background-color: #c82333;
        }

        /* –°—Ç–∏–ª—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
        #chart {
            margin-top: 20px;
        }

        .download-btn {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            margin-right: 10px;
        }

        .download-btn:hover {
            background-color: #0056b3;
        }

        #download-xlsx {
            width: 100%;
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 5px; /* –û—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º */
        }

        #download-xlsx:hover {
            background-color: #0056b3;
        }

        .small-button {
            width: 48%;  /* –î–≤–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ */
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
        }

        .small-button:hover {
            background-color: #0056b3;
        }

        /* –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        #table-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%; /* –®–∏—Ä–∏–Ω–∞ –Ω–∞ 95% —ç–∫—Ä–∞–Ω–∞ */
            max-width: 1400px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —à–∏—Ä–∏–Ω–µ */
            height: 80vh; /* –í—ã—Å–æ—Ç–∞ 80% —ç–∫—Ä–∞–Ω–∞ */
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã */
        #table-container {
            flex-grow: 1;
            overflow: auto; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
            border: 1px solid #ccc;
            max-height: 65vh; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É */
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã */
        #report-table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap; /* –¢–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è */
        }

        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
        #report-table thead {
            position: sticky;
            top: 0;
            background: white;
            z-index: 2;
        }

        /* –î–æ–±–∞–≤–ª–µ–Ω—ã –≥—Ä–∞–Ω–∏—Ü—ã */
        #report-table th, #report-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        /* –¶–≤–µ—Ç–∞ —Å—Ç—Ä–æ–∫ */
        .entomolog { background-color: #fffacd; }  /* –°–≤–µ—Ç–ª–æ-–∂–µ–ª—Ç—ã–π */
        .gerbolog { background-color: #add8e6; }  /* –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π */
        .fitopatolog { background-color: #ffcccb; }  /* –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π */

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
        #close-table {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            display: block;
            width: 100px;
            margin: 10px auto 0;
            text-align: center;
        }

        #close-table:hover {
            background-color: #c82333;
        }


        /* –û—Ç—Å—Ç—É–ø –≤–Ω–∏–∑—É —Å–ø–∏—Å–∫–∞ */
        .spacer {
            height: 270px; /* –†–µ–≥—É–ª–∏—Ä—É–π –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
        }

        #logo-link {
            display: block;
        }
        .header-buttons {
            display: flex;
            gap: 10px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
            margin-right: 30px;
        }

        .header-button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            flex: 1; /* –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ */
            text-align: center;
            min-width: 120px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        }

        .header-button:hover {
            background-color: #0056b3;
        }


    </style>
</head>
<body>
    <div id="header">
        <div class="left">
            <a href="https://www.niizkr.kz/" id="logo-link">
                <div class="logo"></div>
            </a>
            <div class="title">–¢–û–û "–ö–∞–∑–ù–ò–ò–ó–∏–ö–† –∏–º. –ñ. –ñ–∏–µ–º–±–∞–µ–≤–∞"</div>
        </div>
        <div class="header-buttons">
            <button id="prog-button" class="header-button" onclick="window.location.href='http://127.0.0.1:5090'">
            –ü—Ä–æ–≥–Ω–æ–∑
        </button>
        <button id="auto-button" class="header-button" onclick="window.location.href='http://127.0.0.1:5080'">
            –ê–≤—Ç–æ
        </button>
        <button id="stats-button" class="header-button" onclick="toggleStatistics()">
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
    </div>
    </div>
    <div id="content">
        <div id="report-list">
            <h2>–ü–æ–ª–µ–≤–æ–π –ñ—É—Ä–Ω–∞–ª: –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
            <div id="filters">
                <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
                <label for="start-date-filter">–î–∞—Ç–∞ –æ—Ç:</label>
                <div class="date-container" onclick="openCalendar('start-date-filter')">
                    <input type="date" id="start-date-filter" onchange="applyFilters()">
                </div>

                <label for="end-date-filter">–î–∞—Ç–∞ –¥–æ:</label>
                <div class="date-container" onclick="openCalendar('end-date-filter')">
                    <input type="date" id="end-date-filter" onchange="applyFilters()">
                </div>

                <label for="filter-region">–†–µ–≥–∏–æ–Ω:</label>
                <select id="filter-region" onchange="applyFilters()">
                    <option value="">–í—Å–µ</option>
                    {% for region in filters.regions %}
                        <option value="{{ region }}">{{ region }}</option>
                    {% endfor %}
                </select>

                <label for="filter-activity">–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:</label>
                <select id="filter-activity" onchange="applyFilters()">
                    <option value="">–í—Å–µ</option>
                    {% for activity in filters.activity_types %}
                        <option value="{{ activity }}">{{ activity }}</option>
                    {% endfor %}
                </select>

                <label for="filter-work">–í–∏–¥ —Ä–∞–±–æ—Ç:</label>
                <select id="filter-work" onchange="applyFilters()">
                    <option value="">–í—Å–µ</option>
                    {% for work_type in filters.work_types %}
                        <option value="{{ work_type }}">{{ work_type }}</option>
                    {% endfor %}
                </select>

                <button onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <button id="download-reports" onclick="downloadAllReports()" class="small-button">
                    –°–∫–∞—á–∞—Ç—å –≤—Å—ë
                </button>
                <button id="show-table" onclick="showTable()" class="small-button">
                    –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
                </button>
            </div>

            {% for report in reports | sort(attribute="date", reverse=True) %}
                <button class="report-button"
                        data-date="{{ report.date }}"
                        data-region="{{ report.region }}"
                        data-activity="{{ report.activity_type }}"
                        data-work="{{ report.work_type }}"
                        onclick="showReport('{{ report.id }}')">
                    <b>–ù–∞–∑–≤–∞–Ω–∏–µ: {{ report.id }}</b><br>
                    –†–µ–≥–∏–æ–Ω: {{ report.region }}<br>
                    –î–∞—Ç–∞: {{ report.date }}
                </button>
            {% endfor %}
        </div>
        <div id="map"></div>
    </div>

    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div id="stats-modal" style="display: none;">

        <div>
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã</h3>
            <div class="date-container" onclick="openCalendar('start-date')">
                <input type="date" id="start-date">
            </div>

            <div class="date-container" onclick="openCalendar('end-date')">
                <input type="date" id="end-date">
            </div>
            <button onclick="showStatistics()">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>
        <div id="chart"></div>
        <button onclick="toggleStatistics()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á—ë—Ç–∞ -->
    <div id="report-popup" class="popup" style="display: none;">
        <div id="report-popup-header" class="popup-header">
            <button id="download-pdf" class="download-btn" onclick="downloadReportPDF()">–°–∫–∞—á–∞—Ç—å</button>
            <span id="report-title">–û—Ç—á–µ—Ç</span>
            <button class="close-btn" onclick="closePopup()">‚úñ</button>
        </div>
        <div class="popup-content">
            <div class="popup-left">
                <div id="report-details"></div>
            </div>
            <div class="popup-right">
                <div id="photo-container"></div>
                <div id="no-photo-text" class="no-photo">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
            </div>
        </div>
    </div>

    <div id="table-modal" style="display: none;">
        <h3>–¢–∞–±–ª–∏—Ü–∞ –æ—Ç—á–µ—Ç–æ–≤</h3>
        <div id="table-container">
            <table id="report-table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
        <button id="close-table" onclick="closeTable()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        function toggleStatistics() {
            const modal = document.getElementById('stats-modal');
            modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
        }
    </script>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
        var map = L.map('map').setView([48.0196, 66.9237], 5); // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã: –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω, –∑—É–º: 5
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—É —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏ –ø–æ —Ç–∏–ø—É –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        var markers = [];  // –•—Ä–∞–Ω–∏—Ç –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ

        function loadMarkers() {
            markers.forEach(marker => map.removeLayer(marker)); // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
            markers = [];

            {% for report in reports %}
                var iconUrl = '/static/icons/default.png'; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

                if ("{{ report.activity_type }}" === "–≠–Ω—Ç–æ–º–æ–ª–æ–≥") {
                    iconUrl = '/static/icons/p3.png';
                } else if ("{{ report.activity_type }}" === "–ì–µ—Ä–±–æ–ª–æ–≥") {
                    iconUrl = '/static/icons/p1.png';
                } else if ("{{ report.activity_type }}" === "–§–∏—Ç–æ–ø–∞—Ç–æ–ª–æ–≥") {
                    iconUrl = '/static/icons/p2.png';
                }

                var customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });

                var marker = L.marker([{{ report.latitude }}, {{ report.longitude }}], { icon: customIcon });

                marker.data = {
                    id: "{{ report.id }}",
                    date: "{{ report.date }}",
                    region: "{{ report.region }}",
                    activity: "{{ report.activity_type }}",
                    work: "{{ report.work_type }}"
                };

                marker.on('click', function() {
                    showReport('{{ report.id }}');
                });

                markers.push(marker);
                marker.addTo(map); // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç—É
            {% endfor %}
        }

        function filterMarkers() {
            const startDateValue = document.getElementById('start-date-filter').value;
            const endDateValue = document.getElementById('end-date-filter').value;
            const region = document.getElementById('filter-region').value;
            const activity = document.getElementById('filter-activity').value;
            const work = document.getElementById('filter-work').value;

            const startDate = startDateValue ? new Date(startDateValue) : null;
            const endDate = endDateValue ? new Date(endDateValue) : null;

            markers.forEach(marker => {
                const buttonDate = new Date(marker.data.date);
                const buttonRegion = marker.data.region;
                const buttonActivity = marker.data.activity;
                const buttonWork = marker.data.work;

                let isVisible = true;

                if (startDate && buttonDate < startDate) isVisible = false;
                if (endDate && buttonDate > endDate) isVisible = false;
                if (region && buttonRegion !== region) isVisible = false;
                if (activity && buttonActivity !== activity) isVisible = false;
                if (work && buttonWork !== work) isVisible = false;

                if (isVisible) {
                    marker.addTo(map); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä
                } else {
                    map.removeLayer(marker); // –°–∫—Ä—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä
                }
            });
        }

        // –í—ã–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener("DOMContentLoaded", function() {
            loadMarkers();
        });

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∫ —Å–æ–±—ã—Ç–∏—è–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('start-date-filter').addEventListener("change", filterMarkers);
        document.getElementById('end-date-filter').addEventListener("change", filterMarkers);
        document.getElementById('filter-region').addEventListener("change", filterMarkers);
        document.getElementById('filter-activity').addEventListener("change", filterMarkers);
        document.getElementById('filter-work').addEventListener("change", filterMarkers);

        // –ù–∞–ª–æ–∂–µ–Ω–∏–µ JSON —Å –ø–æ–ª–∏–≥–æ–Ω–∞–º–∏
        fetch('/static/kz.json')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: {
                        color: 'green',
                        weight: 2,
                        fillOpacity: 0.1
                    }
                }).addTo(map);
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:', error));

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ç—á–µ—Ç–µ
        function showReport(reportId) {
            fetch('/get_report/' + reportId)
                .then(response => response.json())
                .then(data => {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á–µ—Ç–∞
                    document.getElementById('report-title').textContent = '–û—Ç—á–µ—Ç: ' + data.id;

                    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML-–∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç—á–µ—Ç–∞
                    let detailsHtml = `
                        <p><strong>–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:</strong> ${data.activity_type}</p>
                        <p><strong>–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã:</strong> ${data.work_place}</p>
                        <p><strong>–°—Ç–∞–¥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è:</strong> ${data.development_stage}</p>
                        <p><strong>–•–æ–∑—è–π—Å—Ç–≤–æ:</strong> ${data.farm_name}</p>
                        <p><strong>–î–∞—Ç–∞:</strong> ${data.date}</p>
                        <p><strong>–û–±–ª–∞—Å—Ç—å:</strong> ${data.region}</p>
                        <p><strong>–†–∞–π–æ–Ω:</strong> ${data.district}</p>
                        <p><strong>–®–∏—Ä–æ—Ç–∞:</strong> ${data.latitude}</p>
                        <p><strong>–î–æ–ª–≥–æ—Ç–∞:</strong> ${data.longitude}</p>
                        <p><strong>–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</strong> ${data.work_type}</p>
                        <p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> ${data.executor}</p>
                        <p><strong>–ö—É–ª—å—Ç—É—Ä–∞:</strong> ${data.culture}</p>
                        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${data.description}</p>
                        <p><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong> ${data.results}</p>
                    `;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                    if (data.dynamic_fields && Object.keys(data.dynamic_fields).length > 0) {
                        detailsHtml += `<h4>–î–∞–Ω–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–ª—è:</h4><ul>`;
                        for (const [key, value] of Object.entries(data.dynamic_fields)) {
                            detailsHtml += `<li><strong>${key}:</strong> ${value}</li>`;
                        }
                        detailsHtml += `</ul>`;
                    }

                    document.getElementById('report-details').innerHTML = detailsHtml;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ç–æ
                    let photoContainer = document.getElementById('photo-container');
                    let noPhotoText = document.getElementById('no-photo-text');

                    if (data.photos.length > 0) {
                        photoContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —Ñ–æ—Ç–æ
                        data.photos.forEach(photoUrl => {
                            let img = document.createElement('img');
                            img.src = photoUrl;
                            img.alt = '–§–æ—Ç–æ –æ—Ç—á–µ—Ç–∞';
                            img.style.maxWidth = '100%';
                            img.style.maxHeight = '450px';
                            img.style.borderRadius = '5px';
                            img.style.marginBottom = '5px';
                            photoContainer.appendChild(img);
                        });

                        noPhotoText.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç "–ù–µ—Ç —Ñ–æ—Ç–æ"
                    } else {
                        photoContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        noPhotoText.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
                    let popup = document.getElementById('report-popup');
                    popup.style.display = 'block';

                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ–∫–Ω–æ –≤ —Ü–µ–Ω—Ç—Ä
                    popup.style.top = '50%';
                    popup.style.left = '50%';
                    popup.style.transform = 'translate(-50%, -50%)';
                    map.setView([data.latitude, data.longitude], 12);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞:', error);
                });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
        function closePopup() {
            let popup = document.getElementById('report-popup');
            popup.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            let popup = document.getElementById('report-popup');
            let header = document.getElementById('report-popup-header');

            let offsetX = 0, offsetY = 0, isDragging = false;

            header.addEventListener('mousedown', function (event) {
                isDragging = true;

                // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –ø–æ–∑–∏—Ü–∏–µ–π –∫—É—Ä—Å–æ—Ä–∞ –∏ –≤–µ—Ä—Ö–Ω–∏–º –ª–µ–≤—ã–º —É–≥–ª–æ–º –æ–∫–Ω–∞
                offsetX = event.clientX - popup.getBoundingClientRect().left;
                offsetY = event.clientY - popup.getBoundingClientRect().top;

                document.addEventListener('mousemove', movePopup);
                document.addEventListener('mouseup', stopDrag);
            });

            function movePopup(event) {
                if (isDragging) {
                    popup.style.left = (event.clientX - offsetX) + 'px';
                    popup.style.top = (event.clientY - offsetY) + 'px';
                    popup.style.transform = 'none'; // –£–±–∏—Ä–∞–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                }
            }

            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', movePopup);
                document.removeEventListener('mouseup', stopDrag);
            }
        });



        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            const startDateValue = document.getElementById('start-date-filter').value;
            const endDateValue = document.getElementById('end-date-filter').value;
            const region = document.getElementById('filter-region').value;
            const activity = document.getElementById('filter-activity').value;
            const work = document.getElementById('filter-work').value;

            const startDate = startDateValue ? new Date(startDateValue) : null;
            const endDate = endDateValue ? new Date(endDateValue) : null;

            document.querySelectorAll('.report-button').forEach(button => {
                const buttonDate = new Date(button.dataset.date); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –≤ –æ–±—ä–µ–∫—Ç Date
                const buttonRegion = button.dataset.region;
                const buttonActivity = button.dataset.activity;
                const buttonWork = button.dataset.work;

                let isVisible = true;

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç
                if (startDate && buttonDate < startDate) {
                    isVisible = false;
                }
                if (endDate && buttonDate > endDate) {
                    isVisible = false;
                }

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω—É, –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ç–∏–ø—É —Ä–∞–±–æ—Ç—ã
                if (region && buttonRegion !== region) {
                    isVisible = false;
                }
                if (activity && buttonActivity !== activity) {
                    isVisible = false;
                }
                if (work && buttonWork !== work) {
                    isVisible = false;
                }

                button.style.display = isVisible ? 'block' : 'none';
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function resetFilters() {
            document.getElementById('start-date-filter').value = '';
            document.getElementById('end-date-filter').value = '';
            document.getElementById('filter-region').value = '';
            document.getElementById('filter-activity').value = '';
            document.getElementById('filter-work').value = '';
            filterMarkers();
            applyFilters();

        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∫–ª–∏–∫–µ
        function openCalendar(id) {
            document.getElementById(id).showPicker(); // –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        }


        // –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        document.getElementById('open-stats').addEventListener('click', function() {
            document.getElementById('stats-modal').style.display = 'block';
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        document.getElementById('close-modal').addEventListener('click', function() {
            document.getElementById('stats-modal').style.display = 'none';
        });

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function showStatistics() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç');
                return;
            }

            fetch('/get_statistics', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ start_date: startDate, end_date: endDate }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ —Å –ø–æ–º–æ—â—å—é Plotly
                    const dates = Object.keys(data);
                    const counts = Object.values(data);

                    const trace = {
                        x: dates,
                        y: counts,
                        type: 'bar',
                    };

                    const layout = {
                        title: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç—á–µ—Ç–æ–≤',
                        xaxis: { title: '–î–∞—Ç–∞' },
                        yaxis: { title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤' },
                    };

                    Plotly.newPlot('chart', [trace], layout);
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error));
        }

        function downloadReportPDF() {
            const title = document.getElementById('report-title').textContent;
            const details = document.getElementById('report-details').innerText;
            const images = document.querySelectorAll('#photo-container img');

            let docDefinition = {
                content: [
                    { text: title, style: 'header' },
                    { text: details, style: 'body' },
                ],
                styles: {
                    header: {
                        fontSize: 16,
                        bold: true,
                        margin: [0, 0, 0, 10],
                    },
                    body: {
                        fontSize: 12,
                        margin: [0, 0, 0, 10],
                    }
                }
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            let imagePromises = Array.from(images).map(img => convertImageToBase64(img.src));
            Promise.all(imagePromises).then(base64Images => {
                base64Images.forEach(imgData => {
                    docDefinition.content.push({ image: imgData, width: 300, margin: [0, 10, 0, 10] });
                });

                pdfMake.createPdf(docDefinition).download(title.replace("–û—Ç—á–µ—Ç: ", "") + '.pdf');
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ base64
        function convertImageToBase64(imgUrl) {
            return new Promise((resolve) => {
                let img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = imgUrl;
                img.onload = function () {
                    let canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    let ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/jpeg"));
                };
            });
        }

        async function downloadAllReports() {
            let reportButtons = document.querySelectorAll('.report-button');
            let reports = [];
            let dynamicKeys = new Set(); // –•—Ä–∞–Ω–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è

            for (let button of reportButtons) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∏–∑ onclick
                let onclickAttr = button.getAttribute("onclick");
                let reportIdMatch = onclickAttr.match(/showReport\('(.+?)'\)/);
                let reportId = reportIdMatch ? reportIdMatch[1] : null;

                if (!reportId) {
                    console.warn(`‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω –æ—Ç—á—ë—Ç –±–µ–∑ ID:`, button);
                    continue;
                }

                let response = await fetch('/get_report/' + reportId);
                let data = await response.json();

                if (!data || data.error) {
                    console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–∞ ${reportId}: ${data.error}`);
                    continue;
                }

                // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
                if (data.dynamic_fields) {
                    Object.keys(data.dynamic_fields).forEach(key => dynamicKeys.add(key));
                }

                reports.push(data);
            }

            if (reports.length === 0) {
                alert("–û—à–∏–±–∫–∞: –û—Ç—á—ë—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            let excelHeaders = [
                "ID –æ—Ç—á—ë—Ç–∞", "–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", "–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã", "–°—Ç–∞–¥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è",
                "–•–æ–∑—è–π—Å—Ç–≤–æ", "–î–∞—Ç–∞", "–û–±–ª–∞—Å—Ç—å", "–†–∞–π–æ–Ω", "–®–∏—Ä–æ—Ç–∞", "–î–æ–ª–≥–æ—Ç–∞",
                "–¢–∏–ø —Ä–∞–±–æ—Ç—ã", "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–ö—É–ª—å—Ç—É—Ä–∞", "–û–ø–∏—Å–∞–Ω–∏–µ", "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã"
            ];

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
            let dynamicHeaders = Array.from(dynamicKeys);
            excelHeaders = excelHeaders.concat(dynamicHeaders);

            // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö
            let excelData = [excelHeaders];

            reports.forEach(report => {
                let row = [
                    report.id || "‚Äî",
                    report.activity_type || "‚Äî",
                    report.work_place || "‚Äî",
                    report.development_stage || "‚Äî",
                    report.farm_name || "‚Äî",
                    report.date || "‚Äî",
                    report.region || "‚Äî",
                    report.district || "‚Äî",
                    report.latitude || "‚Äî",
                    report.longitude || "‚Äî",
                    report.work_type || "‚Äî",
                    report.executor || "‚Äî",
                    report.culture || "‚Äî",
                    report.description || "‚Äî",
                    report.results || "‚Äî"
                ];

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
                dynamicHeaders.forEach(key => {
                    row.push(report.dynamic_fields?.[key] || "‚Äî");
                });

                excelData.push(row);
            });

            console.log("üìä –ò—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è XLSX:", excelData);

            let worksheet = XLSX.utils.aoa_to_sheet(excelData);
            let workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "–û—Ç—á—ë—Ç—ã");

            XLSX.writeFile(workbook, "–í—Å–µ_–æ—Ç—á—ë—Ç—ã.xlsx");
        }

        async function showTable() {
            if (document.getElementById("table-modal").style.display === "block") {
            console.warn("showTable() —É–∂–µ –≤—ã–∑–≤–∞–Ω, –ø—Ä–µ—Ä—ã–≤–∞—é...");
            return;
        }
        document.getElementById("table-modal").style.display = "block";
            let reportButtons = document.querySelectorAll('.report-button');
            let reports = [];
            let dynamicKeys = new Set();

            for (let button of reportButtons) {
                let onclickAttr = button.getAttribute("onclick");
                let reportIdMatch = onclickAttr.match(/showReport\('(.+?)'\)/);
                let reportId = reportIdMatch ? reportIdMatch[1] : null;

                if (!reportId) {
                    console.warn(`‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω –æ—Ç—á—ë—Ç –±–µ–∑ ID:`, button);
                    continue;
                }

                let response = await fetch('/get_report/' + reportId);
                let data = await response.json();

                if (!data || data.error) {
                    console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–∞ ${reportId}: ${data.error}`);
                    continue;
                }

                if (data.dynamic_fields) {
                    Object.keys(data.dynamic_fields).forEach(key => dynamicKeys.add(key));
                }

                reports.push(data);
            }

            if (reports.length === 0) {
                alert("–û—à–∏–±–∫–∞: –û—Ç—á—ë—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
                return;
            }

            let table = document.getElementById('report-table');
            let thead = table.querySelector('thead');
            let tbody = table.querySelector('tbody');

            thead.innerHTML = "";
            tbody.innerHTML = "";

            let headers = [
                "ID –æ—Ç—á—ë—Ç–∞", "–í–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", "–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã", "–°—Ç–∞–¥–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è",
                "–•–æ–∑—è–π—Å—Ç–≤–æ", "–î–∞—Ç–∞", "–û–±–ª–∞—Å—Ç—å", "–†–∞–π–æ–Ω", "–®–∏—Ä–æ—Ç–∞", "–î–æ–ª–≥–æ—Ç–∞",
                "–¢–∏–ø —Ä–∞–±–æ—Ç—ã", "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "–ö—É–ª—å—Ç—É—Ä–∞", "–û–ø–∏—Å–∞–Ω–∏–µ", "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã"
            ];

            let dynamicHeaders = Array.from(dynamicKeys);
            headers = headers.concat(dynamicHeaders);

            let headerRow = document.createElement('tr');
            headers.forEach(header => {
                let th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            reports.forEach(report => {
                let row = document.createElement('tr');

                let activityType = report.activity_type || "‚Äî";
                row.classList.add(
                    activityType.includes("–≠–Ω—Ç–æ–º–æ–ª–æ–≥") ? "entomolog" :
                    activityType.includes("–ì–µ—Ä–±–æ–ª–æ–≥") ? "gerbolog" :
                    activityType.includes("–§–∏—Ç–æ–ø–∞—Ç–æ–ª–æ–≥") ? "fitopatolog" :
                    ""
                );

                let rowData = [
                    report.id || "‚Äî",
                    report.activity_type || "‚Äî",
                    report.work_place || "‚Äî",
                    report.development_stage || "‚Äî",
                    report.farm_name || "‚Äî",
                    report.date || "‚Äî",
                    report.region || "‚Äî",
                    report.district || "‚Äî",
                    report.latitude || "‚Äî",
                    report.longitude || "‚Äî",
                    report.work_type || "‚Äî",
                    report.executor || "‚Äî",
                    report.culture || "‚Äî",
                    report.description || "‚Äî",
                    report.results || "‚Äî"
                ];

                dynamicHeaders.forEach(key => {
                    rowData.push(report.dynamic_fields?.[key] || "‚Äî");
                });

                rowData.forEach(cellData => {
                    let td = document.createElement('td');
                    td.textContent = cellData;
                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });

            document.getElementById('table-modal').style.display = 'block';
        }

        function closeTable() {
            document.getElementById('table-modal').style.display = 'none';
        }



    </script>
</body>
</html>
